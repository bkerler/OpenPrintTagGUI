# (c) B.Kerler 2025
# GPLv3 License

from typing import Tuple, Optional, Dict
import re

ral_database = {
    '1000': (190, 183, 153), '1001': (208, 176, 132), '1002': (198, 166, 100),
    '1003': (229, 165, 0), '1004': (225, 155, 0), '1005': (196, 143, 0),
    '1006': (225, 153, 0), '1007': (225, 140, 0), '1011': (196, 135, 81),
    '1012': (198, 172, 0), '1013': (227, 222, 207), '1014': (221, 196, 141),
    '1015': (230, 214, 180), '1016': (237, 255, 0), '1017': (240, 147, 0),
    '1018': (247, 218, 0), '1019': (168, 142, 120), '1020': (153, 142, 99),
    '1021': (243, 202, 0), '1023': (240, 195, 0), '1024': (186, 143, 61),
    '1026': (255, 255, 0), '1027': (186, 148, 0), '1028': (255, 183, 0),
    '1032': (214, 171, 0), '1033': (243, 165, 0), '1034': (196, 130, 74),
    '1037': (240, 147, 0),

    '2000': (214, 100, 0), '2001': (196, 65, 19), '2002': (203, 60, 32),
    '2003': (255, 117, 55), '2004': (228, 91, 0), '2005': (255, 77, 0),
    '2007': (255, 167, 0), '2008': (247, 108, 0), '2009': (237, 84, 0),
    '2010': (214, 94, 32), '2011': (255, 117, 0), '2012': (221, 97, 89),
    '2013': (196, 78, 65),

    '3000': (175, 43, 32), '3001': (165, 30, 30), '3002': (163, 33, 33),
    '3003': (140, 28, 28), '3004': (117, 28, 28), '3005': (89, 21, 28),
    '3007': (61, 28, 28), '3009': (107, 43, 40), '3011': (132, 40, 40),
    '3012': (186, 122, 107), '3013': (196, 61, 48), '3014': (214, 122, 117),
    '3015': (221, 163, 173), '3016': (179, 61, 48), '3017': (214, 66, 79),
    '3018': (214, 66, 89), '3020': (204, 0, 0), '3022': (214, 89, 77),
    '3024': (255, 0, 0), '3026': (255, 0, 89), '3027': (186, 0, 77),
    '3028': (204, 0, 0), '3031': (179, 43, 74), '3032': (122, 0, 48),
    '3033': (163, 56, 56),

    '4001': (140, 89, 153), '4002': (163, 74, 99), '4003': (214, 112, 186),
    '4004': (110, 28, 61), '4005': (122, 89, 163), '4006': (153, 61, 163),
    '4007': (79, 28, 74), '4008': (153, 74, 153), '4009': (168, 135, 158),
    '4010': (204, 61, 158), '4011': (132, 117, 168), '4012': (153, 140, 163),

    '5000': (40, 61, 99), '5001': (0, 74, 99), '5002': (0, 61, 153),
    '5003': (0, 61, 117), '5004': (0, 0, 0), '5005': (0, 74, 153),
    '5007': (61, 102, 153), '5008': (61, 79, 89), '5009': (61, 112, 153),
    '5010': (0, 89, 153), '5011': (0, 40, 74), '5012': (0, 135, 186),
    '5013': (0, 61, 117), '5014': (99, 122, 158), '5015': (0, 135, 204),
    '5017': (0, 94, 135), '5018': (0, 158, 158), '5019': (0, 102, 153),
    '5020': (0, 74, 79), '5021': (0, 122, 135), '5022': (40, 40, 117),
    '5023': (74, 102, 153), '5024': (99, 158, 196), '5025': (0, 112, 163),
    '5026': (0, 40, 153),

    '6000': (74, 130, 89), '6001': (61, 110, 61), '6002': (61, 122, 61),
    '6003': (79, 89, 61), '6004': (0, 89, 89), '6005': (40, 79, 61),
    '6006': (61, 61, 48), '6007': (61, 74, 48), '6008': (61, 74, 48),
    '6009': (40, 61, 40), '6010': (74, 122, 61), '6011': (89, 122, 89),
    '6012': (61, 79, 61), '6013': (122, 135, 99), '6014': (74, 74, 48),
    '6015': (61, 61, 61), '6016': (0, 130, 89), '6017': (74, 135, 61),
    '6018': (89, 186, 74), '6019': (204, 237, 196), '6020': (61, 79, 48),
    '6021': (135, 168, 122), '6022': (61, 61, 40), '6024': (0, 153, 74),
    '6025': (74, 135, 61), '6026': (0, 122, 102), '6027': (122, 204, 204),
    '6028': (61, 110, 74), '6029': (0, 135, 61), '6031': (0, 102, 89),
    '6032': (0, 153, 89), '6033': (0, 158, 158), '6034': (122, 204, 204),
    '6035': (0, 135, 61), '6036': (0, 122, 117), '6037': (0, 153, 0),
    '6038': (0, 237, 0),

    '7000': (122, 135, 140), '7001': (135, 148, 158), '7002': (130, 122, 99),
    '7003': (122, 125, 117), '7004': (158, 158, 158), '7005': (135, 140, 130),
    '7006': (153, 140, 122), '7008': (130, 112, 89), '7009': (135, 140, 122),
    '7010': (107, 112, 107), '7011': (89, 99, 107), '7012': (107, 112, 107),
    '7013': (89, 89, 74), '7015': (79, 79, 89), '7016': (61, 70, 79),
    '7021': (40, 40, 48), '7022': (74, 74, 74), '7023': (107, 112, 107),
    '7024': (61, 70, 79), '7026': (61, 79, 89),

    '8000': (153, 122, 89), '8001': (168, 112, 74), '8002': (122, 79, 61),
    '8003': (140, 89, 61), '8004': (168, 89, 61), '8007': (122, 74, 48),
    '8008': (153, 102, 61), '8011': (107, 61, 48), '8012': (107, 48, 48),
    '8014': (89, 61, 48), '8015': (89, 48, 48), '8016': (89, 48, 40),
    '8017': (74, 48, 40), '8019': (61, 48, 48), '8022': (0, 0, 0),
    '8023': (186, 94, 48), '8024': (140, 79, 48), '8025': (153, 112, 89),
    '8027': (107, 61, 40), '8028': (122, 79, 48), '8029': (153, 79, 61),

    '9001': (237, 230, 214), '9002': (214, 209, 196), '9003': (242, 242, 242),
    '9004': (0, 0, 0), '9005': (0, 0, 0), '9006': (163, 163, 163),
    '9007': (140, 140, 140), '9010': (237, 237, 230), '9011': (28, 28, 28),
    '9012': (214, 224, 214), '9016': (242, 250, 250), '9017': (28, 28, 28),
    '9018': (204, 224, 204), '9022': (158, 158, 158), '9023': (130, 130, 130),
}

def _hex_to_rgb(hex_color: str) -> Tuple[int, int, int]:
    """Convert #RRGGBB or RRGGBB to (R, G, B)"""
    hex_color = hex_color.lstrip('#')[:6]
    if len(hex_color) != 6:
        raise ValueError("Hex color must be 6 characters long.")
    return tuple(int(hex_color[i:i + 2], 16) for i in (0, 2, 4))


def _rgb_to_hex(rgb: Tuple[int, int, int]) -> str:
    """Convert (R, G, B) to #RRGGBB"""
    return '#ff{:02x}{:02x}{:02x}'.format(*rgb)


def _ral_to_rgb(ral_code: str) -> Tuple[int, int, int]:
    """Convert RAL code to RGB tuple"""
    code = re.sub(r'\D', '', ral_code.upper())  # Extract digits only
    if not code or len(code) != 4:
        raise ValueError(f"Invalid RAL code: {ral_code}")

    if code not in ral_database:
        raise ValueError(f"RAL {code} not found in database.")

    return ral_database[code]


# === MAIN FUNCTIONS ===

def ral_to_hex(ral_code: str) -> str:
    """
    Convert RAL code to HEX string.

    Args:
        ral_code: 'RAL 9010', '9010', 'ral9010'

    Returns:
        str: '#RRGGBB'
    """
    rgb = _ral_to_rgb(ral_code)
    return _rgb_to_hex(rgb).lower()


def hex_to_ral(hex_color: str, return_distance: bool = False) -> Tuple[str, Optional[float]]:
    """
    Convert HEX color to closest RAL code.

    Args:
        hex_color: '#FFFFFF' or 'FFFFFF'
        return_distance: If True, return (RAL, distance)

    Returns:
        str or tuple: 'RAL XXXX' or ('RAL XXXX', distance)
    """
    rgb = _hex_to_rgb(hex_color)

    min_dist = float('inf')
    closest_ral = None

    for code in ral_database:
        ral_rgb = ral_database[code]
        # Euclidean distance in RGB space
        dist = sum((a - b) ** 2 for a, b in zip(rgb, ral_rgb)) ** 0.5
        if dist < min_dist:
            min_dist = dist
            closest_ral = f"RAL{code}"

    if return_distance:
        return closest_ral, min_dist
    return closest_ral